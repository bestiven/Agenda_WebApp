<script>

  // Botón subir
  window.addEventListener('scroll', function() {
    if (window.scrollY > 400) {
      document.getElementById('botonSubir').style.transform = 'scale(1)';
    } else {
      document.getElementById('botonSubir').style.transform = 'scale(0)';
    }
  });

  //evento de cargar imagen
    document.getElementById('imagen').addEventListener("change",function(){
      document.getElementById('imgForm').src = URL.createObjectURL(this.files[0])
    });


  function subirArriba(){
    console.log('hace el Scroll')
    window.scrollTo({
    top: 0,
    behavior: 'smooth' // Hace el scroll suave
  });
  }

  function limpiar(){
    borrarTabla();
    eliminarTarjetas();
    //crear loader 
    crearLoader('divContactos');

  }

  function mostrar(){
    crearTarjetasContactos();
    eliminarLoader();
  }

  //const NOTIFICACION_OK = 1;
  //const NOTIFICACION_DANGER= 2;
  //const NOTIFICACION_WARNING = 3;


  // INSERTAR CONTACTO 

  function insertarContacto(){
    
    limpiar();
    //cerrar modal 
    bootstrap.Modal.getInstance(document.getElementById('crearContactoModal')).hide();
    

    let contacto = guardarDatosContacto();
    let archivo = document.getElementById('imagen').files[0];

    if(archivo) subirImagen(contacto,archivo);
    else{
      google.script.run
      .withSuccessHandler(contactoInsertadoCorrectamente)
      .withFailureHandler(contactoInsertadoError)
      .insertarContacto(contacto);
    }

  
    
  }

  function guardarDatosContacto(){
   
    let contacto ={
      nombre    :   document.getElementById('nombre').value,
      apellidos :   document.getElementById('apellidos').value,
      correo    :   document.getElementById('correo').value,
      telf      :   document.getElementById('telf').value,
      imagen    :   document.getElementById('imgForm').src


    };
    console.log('contacto',contacto);
    return contacto;
  }

  function subirImagen(contacto,archivo){
    let fr = new FileReader();
    fr.readAsArrayBuffer(archivo);


    fr.onload = function(){

      let imagen = {
        nombre:archivo.name,
        tipo: archivo.type,
        datos:Array.from(new Int8Array(this.result))
       
      };

      google.script.run
      .withSuccessHandler(contactoInsertadoCorrectamente)
      .withFailureHandler(contactoInsertadoError)
      .insertarContacto(contacto,imagen);
    }
  }


  function contactoInsertadoCorrectamente() {
    // Eliminamos los datos de los inputs
    document.getElementById('nombre').value = '';
    document.getElementById('correo').value = '';

    // Mostrar notificación
    crearNotificacionContacto('Contacto insertado correctamente','CONTACTO OK')
  
    mostrar();
  }

  function contactoInsertadoError() {
    crearNotificacionError('No se ha podido insertar el contacto', 'ERROR');

    mostrar();
  }

  //  MODIFICAR CONTACTO 
  
  function modificarContacto(numFila){

    limpiar();

    //cerrar modal
    bootstrap.Modal.getOrCreateInstance(document.getElementById('crearContactoModal')).hide();

    //Obtener nuevos datos apartir del form
    let nombre = document.getElementById('nombre').value;
    let apellidos = document.getElementById('apellidos').value;
    let correo = document.getElementById('correo').value;
    let telf = document.getElementById('telf').value;

    google.script.run
    .withSuccessHandler(contactoModificadoCorrectamente)
    .withFailureHandler(contactoModificadoError) 
    .modificarContacto(numFila,{nombre,apellidos,correo,telf});
  }

  function contactoModificadoCorrectamente(){
     // Mostrar notificación
    crearNotificacionContacto('Contacto Modificado correctamente','MODIFICADO OK')
    mostrar();
  }

  function contactoModificadoError(){
    crearNotificacionError('No se ha podido Modificar el contacto', 'ERROR');
    mostrar();
  }

  // BORRAR CONTACTO 
  function borrarContacto(numFila){
    
    limpiar();

    google.script.run
    .withSuccessHandler(contactoBorradoCorrectamente)
    .withFailureHandler(contactoBorradoError) 
    .borrarContacto(numFila);
  }


  function contactoBorradoCorrectamente(){
    // Mostrar notificación
    crearNotificacionBorrar('Contacto Borrado correctamente','BORRADO OK')

    mostrar();
  }

  function contactoBorradoError(){
    crearNotificacionError('No se ha podido borrar el contacto', 'ERROR');

    mostrar();
  }

 
  // IMPORTAR CONTACTO 
  function importarContactos(){

    limpiar();

    google.script.run
    .withSuccessHandler(contactosImportadosCorrectamente)
    .withFailureHandler(contactosImportadosError) 
    .importarContactos();
  }

  function contactosImportadosCorrectamente(){
    // Mostrar notificación
    crearNotificacionOK('Contacto Importado correctamente','IMPORTADO OK')

    mostrar();

  }

  function contactosImportadosError(){
    crearNotificacionError('No se ha podido Importar el contacto', 'ERROR');
      mostrar();
    
  }



  

</script>
